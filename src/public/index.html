<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and rounded corners */
        body {
            font-family: 'Inter', sans-serif;
        }
        .rounded-xl {
            border-radius: 0.75rem; /* Tailwind's default rounded-xl */
        }
        table {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-500 to-gray-600 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">SHORTEN! THAT!! URL!!!</h1>

        <form id="shortenForm" class="space-y-4">
            <div>
                <label for="longUrl" class="block text-sm font-medium text-gray-700 mb-1">Enter Long URL:</label>
                <input
                    type="url"
                    id="longUrl"
                    name="longUrl"
                    placeholder="https://example.com/very/long/url"
                    required
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
            </div>
            <button
                type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
            >
                Get Short URL
            </button>
        </form>

        <div id="result" class="mt-6 hidden">
            <p class="text-gray-700 text-sm font-medium mb-2">Your Shortened URL:</p>
            <div class="flex items-center space-x-2">
                <input
                    type="text"
                    id="shortenedUrlDisplay"
                    readonly
                    class="flex-grow px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-900 cursor-text sm:text-sm"
                >
                <button
                    id="copyButton"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"
                >
                    Copy
                </button>

            </div>
            
        </div>

        <div id="errorMessage" class="mt-4 text-red-600 text-sm text-center hidden"></div>

    </div>

    <div class="bg-green-500 p-8 rounded-xl shadow-2xl w-full max-w-md mt-4" id="copyMessage" style="display:none">
        <p class="text-xs text-white mt-2">Copied to clipboard!</p>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mt-4">
        <div id="dataContainer" class="mt-6 text-gray-600 text-xs text-center">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">All Shortened URLs</h1>
            <h1 class="text-xl font-extrabold text-gray-900 mb-6 text-center">Click on a row to copy the URL</h1>
            <table id="dataTable"></table>
            <p>Note: This is a demo application. URLs are stored in memory and will be lost when the server restarts.</p>
        </div>
    </div>
    <script>
       

        document.addEventListener('DOMContentLoaded', async () => {
            const shortenForm = document.getElementById('shortenForm');
            const longUrlInput = document.getElementById('longUrl');
            const resultDiv = document.getElementById('result');
            const shortenedUrlDisplay = document.getElementById('shortenedUrlDisplay');
            const copyButton = document.getElementById('copyButton');
            const copyMessage = document.getElementById('copyMessage');
            const errorMessageDiv = document.getElementById('errorMessage');

            const fillTable = async () => {
                const shortCodesRequest = await fetch('/api/list-short-codes');
                const { shortCodes } = await shortCodesRequest.json();
                const tableBody = document.getElementById('dataTable');
                tableBody.innerHTML = ''; // Clear existing table data

                shortCodes.forEach(({ shortCode, url, short_url }) => {
                    const row = document.createElement('tr');
                    const id = `input-${shortCode}`;
                    row.innerHTML = `
                        <td class="border px-4 py-2">${shortCode}</td>
                        <td class="border px-4 py-2">${url}</td>
                        <input style="display:none" type="text" id="${id}" value="${short_url}" />
                    `;
                    tableBody.appendChild(row);
                    row.addEventListener('click', () => {
                        const element = document.getElementById(id);
                        element.style.display = 'block'; // Make input visible to select
                        copyToClipboard(element);
                        element.style.display = 'none'; // Hide input again after copying
                    });
                });
            };

            const copyToClipboard = (element) => {
                element.select();
                document.execCommand('copy'); // Fallback for navigator.clipboard.writeText
                copyMessage.style.display = 'block';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 2000); // Hide message after 2 seconds
            };

            await fillTable();

            shortenForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const longUrl = longUrlInput.value;
                errorMessageDiv.classList.add('hidden'); // Hide previous errors
                copyMessage.classList.add('hidden'); // Hide previous copy messages

                try {
                    const response = await fetch('/shorten', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: longUrl }),
                    });

                    const data = await response.json();
                    await fillTable(); // Refresh the table with new data - probably better to do an optimistic update or similar in the real world

                    if (response.ok) {
                        shortenedUrlDisplay.value = data.short_url;
                        resultDiv.classList.remove('hidden');
                    } else {
                        errorMessageDiv.textContent = data.error || 'Something went wrong.';
                        errorMessageDiv.classList.remove('hidden');
                        resultDiv.classList.add('hidden'); // Hide result if there's an error
                    }
                } catch (error) {
                    console.error('Error:', error);
                    errorMessageDiv.textContent = 'Could not connect to the server. Please try again later.';
                    errorMessageDiv.classList.remove('hidden');
                    resultDiv.classList.add('hidden'); // Hide result if there's an error
                }
            });

            copyButton.addEventListener('click', () => {
                copyToClipboard(shortenedUrlDisplay);
            });
        });
    </script>
</body>
</html>
